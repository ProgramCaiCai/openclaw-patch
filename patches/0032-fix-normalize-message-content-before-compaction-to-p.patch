From a0ca82c67ea0ab4fac6dfb25ca13f46aec5b08d6 Mon Sep 17 00:00:00 2001
From: programcaicai <programcaicai@programcaicaideMac-mini.local>
Date: Mon, 9 Feb 2026 22:23:13 +0800
Subject: [PATCH 32/44] fix: normalize message content before compaction to
 prevent filter crash

---
 src/agents/pi-embedded-runner/compact.ts | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/src/agents/pi-embedded-runner/compact.ts b/src/agents/pi-embedded-runner/compact.ts
index 280e7d0ab..2a3f3849c 100644
--- a/src/agents/pi-embedded-runner/compact.ts
+++ b/src/agents/pi-embedded-runner/compact.ts
@@ -108,6 +108,21 @@ export type CompactEmbeddedPiSessionParams = {
   ownerNumbers?: string[];
 };
 
+function normalizeMessageContent(messages: Array<{ content?: unknown }>): void {
+  for (const message of messages) {
+    if (Array.isArray(message.content)) {
+      continue;
+    }
+    if (typeof message.content === "string") {
+      message.content = [{ type: "text", text: message.content }];
+      continue;
+    }
+    if (message.content == null) {
+      message.content = [];
+    }
+  }
+}
+
 /**
  * Core compaction logic without lane queueing.
  * Use this when already inside a session/global lane to avoid deadlocks.
@@ -436,6 +451,7 @@ export async function compactEmbeddedPiSessionDirect(
         if (limited.length > 0) {
           session.agent.replaceMessages(limited);
         }
+        normalizeMessageContent(session.messages as Array<{ content?: unknown }>);
         const result = await session.compact(params.customInstructions);
         // Estimate tokens after compaction by summing token estimates for remaining messages
         let tokensAfter: number | undefined;
-- 
2.50.1 (Apple Git-155)

