From 4e168eeea1f5fd07ee4f8cf0ad78b9e54d95161c Mon Sep 17 00:00:00 2001
From: programcaicai <programcaicai@programcaicaideMac-mini.local>
Date: Tue, 10 Feb 2026 18:13:46 +0800
Subject: [PATCH 42/44] refactor(agents): unify ctx_safe_call tool naming

---
 .../naming-fix.md                             | 36 +++++++++++++++++++
 src/agents/openclaw-tools.sessions.test.ts    |  6 ++--
 ...ool.test.ts => ctx-safe-call-tool.test.ts} | 26 +++++++-------
 ...afe-call-tool.ts => ctx-safe-call-tool.ts} | 26 +++++++-------
 4 files changed, 65 insertions(+), 29 deletions(-)
 create mode 100644 reports/ctx-safe-call-provider-tools/naming-fix.md
 rename src/agents/tools/{safe-call-tool.test.ts => ctx-safe-call-tool.test.ts} (92%)
 rename src/agents/tools/{safe-call-tool.ts => ctx-safe-call-tool.ts} (94%)

diff --git a/reports/ctx-safe-call-provider-tools/naming-fix.md b/reports/ctx-safe-call-provider-tools/naming-fix.md
new file mode 100644
index 000000000..80276f9f7
--- /dev/null
+++ b/reports/ctx-safe-call-provider-tools/naming-fix.md
@@ -0,0 +1,36 @@
+# ctx_safe_call naming fix
+
+## Scope
+
+- Unified tool implementation/test filenames with `ctx_safe_call` naming.
+- Updated symbol names from `createSafeCallTool` to `createCtxSafeCallTool`.
+- Updated options/schema type names from `SafeCall*` tool identifiers to `CtxSafeCall*` where applicable.
+- Updated schema assertions in session tools tests from `safe_call` to `ctx_safe_call`.
+
+## Changes
+
+- Renamed `src/agents/tools/safe-call-tool.ts` -> `src/agents/tools/ctx-safe-call-tool.ts`.
+- Renamed `src/agents/tools/safe-call-tool.test.ts` -> `src/agents/tools/ctx-safe-call-tool.test.ts`.
+- In `src/agents/tools/ctx-safe-call-tool.ts`:
+  - `createSafeCallTool` -> `createCtxSafeCallTool`
+  - `SafeCallToolOptions` -> `CtxSafeCallToolOptions`
+  - `SafeCallToolSchema` -> `CtxSafeCallToolSchema`
+  - tool name / self-wrap guard / error text / call id marker: `safe_call` -> `ctx_safe_call`
+- In `src/agents/tools/ctx-safe-call-tool.test.ts`:
+  - import path + factory name updated to `ctx` variants
+  - self-wrap test case updated to `ctx_safe_call`
+- In `src/agents/openclaw-tools.sessions.test.ts`:
+  - schema expectations now target `ctx_safe_call`.
+
+## Verification
+
+- Test command:
+  - `npx vitest run src/agents/tools/ctx-safe-call-tool.test.ts`
+  - Result: pass (9 tests).
+- Build command:
+  - `npm run build`
+  - Result: pass.
+
+## Commit
+
+- Pending (fill after commit).
diff --git a/src/agents/openclaw-tools.sessions.test.ts b/src/agents/openclaw-tools.sessions.test.ts
index bfa3ded60..39ee41774 100644
--- a/src/agents/openclaw-tools.sessions.test.ts
+++ b/src/agents/openclaw-tools.sessions.test.ts
@@ -73,9 +73,9 @@ describe("sessions tools", () => {
     expect(schemaProp("sessions_spawn", "thinking").type).toBe("string");
     expect(schemaProp("sessions_spawn", "runTimeoutSeconds").type).toBe("number");
     expect(schemaProp("sessions_spawn", "timeoutSeconds").type).toBe("number");
-    expect(schemaProp("safe_call", "maxChars").type).toBe("number");
-    expect(schemaProp("safe_call", "offset").type).toBe("number");
-    expect(schemaProp("safe_call", "limit").type).toBe("number");
+    expect(schemaProp("ctx_safe_call", "maxChars").type).toBe("number");
+    expect(schemaProp("ctx_safe_call", "offset").type).toBe("number");
+    expect(schemaProp("ctx_safe_call", "limit").type).toBe("number");
   });
 
   it("sessions_list filters kinds and includes messages", async () => {
diff --git a/src/agents/tools/safe-call-tool.test.ts b/src/agents/tools/ctx-safe-call-tool.test.ts
similarity index 92%
rename from src/agents/tools/safe-call-tool.test.ts
rename to src/agents/tools/ctx-safe-call-tool.test.ts
index 7f99ea468..a916b4563 100644
--- a/src/agents/tools/safe-call-tool.test.ts
+++ b/src/agents/tools/ctx-safe-call-tool.test.ts
@@ -1,6 +1,6 @@
 import { describe, expect, it } from "vitest";
 import type { AnyAgentTool } from "./common.js";
-import { createSafeCallTool } from "./safe-call-tool.js";
+import { createCtxSafeCallTool } from "./ctx-safe-call-tool.js";
 
 function createStubTool(payload: unknown): AnyAgentTool {
   return {
@@ -33,14 +33,14 @@ function hasDanglingSurrogate(text: string): boolean {
   return false;
 }
 
-describe("safe_call tool", () => {
+describe("ctx_safe_call tool", () => {
   it("applies fields and array pagination", async () => {
     const stub = createStubTool([
       { id: 1, name: "one" },
       { id: 2, name: "two" },
       { id: 3, name: "three" },
     ]);
-    const tool = createSafeCallTool({
+    const tool = createCtxSafeCallTool({
       resolveTool: (name) => (name === "stub" ? stub : undefined),
     });
 
@@ -70,7 +70,7 @@ describe("safe_call tool", () => {
 
   it("paginates non-array payloads by line", async () => {
     const stub = createStubTool({ a: 1, b: 2, c: 3 });
-    const tool = createSafeCallTool({
+    const tool = createCtxSafeCallTool({
       resolveTool: (name) => (name === "stub" ? stub : undefined),
     });
 
@@ -100,7 +100,7 @@ describe("safe_call tool", () => {
 
   it("truncates oversized output with head and tail", async () => {
     const stub = createStubTool(`HEAD-${"x".repeat(120)}-TAIL`);
-    const tool = createSafeCallTool({
+    const tool = createCtxSafeCallTool({
       resolveTool: (name) => (name === "stub" ? stub : undefined),
     });
 
@@ -124,21 +124,21 @@ describe("safe_call tool", () => {
 
   it("rejects unknown tools and self wrapping", async () => {
     const stub = createStubTool({ ok: true });
-    const tool = createSafeCallTool({
+    const tool = createCtxSafeCallTool({
       resolveTool: (name) => (name === "stub" ? stub : undefined),
     });
 
     await expect(tool.execute("call-4", { tool: "missing", params: {} })).rejects.toThrow(
       "Unknown tool: missing",
     );
-    await expect(tool.execute("call-5", { tool: "safe_call", params: {} })).rejects.toThrow(
-      "safe_call cannot wrap itself",
+    await expect(tool.execute("call-5", { tool: "ctx_safe_call", params: {} })).rejects.toThrow(
+      "ctx_safe_call cannot wrap itself",
     );
   });
 
   it("rejects prototype pollution field paths", async () => {
     const stub = createStubTool([{ id: 1 }]);
-    const tool = createSafeCallTool({
+    const tool = createCtxSafeCallTool({
       resolveTool: (name) => (name === "stub" ? stub : undefined),
     });
 
@@ -189,7 +189,7 @@ describe("safe_call tool", () => {
         details: payload,
       }),
     };
-    const tool = createSafeCallTool({
+    const tool = createCtxSafeCallTool({
       resolveTool: (name) => (name === "stub" ? stub : undefined),
     });
 
@@ -224,7 +224,7 @@ describe("safe_call tool", () => {
       }),
     };
 
-    const tool = createSafeCallTool({
+    const tool = createCtxSafeCallTool({
       resolveTool: (name) => (name === "stub" ? stub : undefined),
     });
 
@@ -247,7 +247,7 @@ describe("safe_call tool", () => {
 
   it("handles very small maxChars", async () => {
     const stub = createStubTool("abcdef");
-    const tool = createSafeCallTool({
+    const tool = createCtxSafeCallTool({
       resolveTool: (name) => (name === "stub" ? stub : undefined),
     });
 
@@ -268,7 +268,7 @@ describe("safe_call tool", () => {
 
   it("does not emit dangling surrogates after truncation", async () => {
     const stub = createStubTool(`START-${"üòÄ".repeat(80)}-END`);
-    const tool = createSafeCallTool({
+    const tool = createCtxSafeCallTool({
       resolveTool: (name) => (name === "stub" ? stub : undefined),
     });
 
diff --git a/src/agents/tools/safe-call-tool.ts b/src/agents/tools/ctx-safe-call-tool.ts
similarity index 94%
rename from src/agents/tools/safe-call-tool.ts
rename to src/agents/tools/ctx-safe-call-tool.ts
index 6d69090d7..580b0259b 100644
--- a/src/agents/tools/safe-call-tool.ts
+++ b/src/agents/tools/ctx-safe-call-tool.ts
@@ -12,12 +12,12 @@ const DEFAULT_MAX_CHARS = 2000;
 const TRUNCATION_HINT = "ÊèêÁ§∫: Áî® offset ÁøªÈ°µÊü•ÁúãÊõ¥Â§ö";
 const BLOCKED_FIELD_SEGMENTS = new Set(["__proto__", "constructor", "prototype"]);
 
-type SafeCallPolicy = {
+type CtxSafeCallPolicy = {
   allowWrapping?: boolean;
   allowedParams?: Set<string>;
 };
 
-const SafeCallToolSchema = Type.Object({
+const CtxSafeCallToolSchema = Type.Object({
   tool: Type.String(),
   params: Type.Optional(Type.Object({}, { additionalProperties: true })),
   maxChars: Type.Optional(Type.Number({ minimum: 1 })),
@@ -26,7 +26,7 @@ const SafeCallToolSchema = Type.Object({
   fields: Type.Optional(Type.Array(Type.String())),
 });
 
-type SafeCallToolOptions = {
+type CtxSafeCallToolOptions = {
   resolveTool: (name: string) => AnyAgentTool | undefined;
 };
 
@@ -299,7 +299,7 @@ function extractPayload(result: unknown): unknown {
   return result;
 }
 
-function readSafeCallPolicy(tool: AnyAgentTool): SafeCallPolicy {
+function readCtxSafeCallPolicy(tool: AnyAgentTool): CtxSafeCallPolicy {
   const toolRecord = tool as unknown as Record<string, unknown>;
   const policyRaw = toolRecord.safeCall;
   if (!isRecord(policyRaw)) {
@@ -338,18 +338,18 @@ function selectTargetParams(
   return selected;
 }
 
-export function createSafeCallTool(options: SafeCallToolOptions): AnyAgentTool {
+export function createCtxSafeCallTool(options: CtxSafeCallToolOptions): AnyAgentTool {
   return {
     label: "Safe Call",
-    name: "safe_call",
+    name: "ctx_safe_call",
     description:
       "Call another tool and safely post-process its output with field filtering, pagination, and maxChars truncation.",
-    parameters: SafeCallToolSchema,
+    parameters: CtxSafeCallToolSchema,
     execute: async (toolCallId, args) => {
       const params = args as Record<string, unknown>;
       const toolName = readStringParam(params, "tool", { required: true });
-      if (toolName === "safe_call") {
-        throw new Error("safe_call cannot wrap itself");
+      if (toolName === "ctx_safe_call") {
+        throw new Error("ctx_safe_call cannot wrap itself");
       }
 
       const target = options.resolveTool(toolName);
@@ -357,14 +357,14 @@ export function createSafeCallTool(options: SafeCallToolOptions): AnyAgentTool {
         throw new Error(`Unknown tool: ${toolName}`);
       }
 
-      const policy = readSafeCallPolicy(target);
+      const policy = readCtxSafeCallPolicy(target);
       if (policy.allowWrapping === false) {
-        throw new Error(`Tool does not allow safe_call wrapping: ${toolName}`);
+        throw new Error(`Tool does not allow ctx_safe_call wrapping: ${toolName}`);
       }
 
       const targetParamsRaw = params.params;
       const targetParamsSource = isRecord(targetParamsRaw) ? targetParamsRaw : {};
-      // Security boundary: safe_call forwards tool-specific params by default; target tools may
+      // Security boundary: ctx_safe_call forwards tool-specific params by default; target tools may
       // opt into stricter wrapping via `safeCall.allowWrapping` and `safeCall.allowedParams`.
       const targetParams = selectTargetParams(targetParamsSource, policy.allowedParams);
 
@@ -385,7 +385,7 @@ export function createSafeCallTool(options: SafeCallToolOptions): AnyAgentTool {
           : DEFAULT_MAX_CHARS;
 
       const targetResult = await target.execute(
-        `${toolCallId}:safe_call:${toolName}`,
+        `${toolCallId}:ctx_safe_call:${toolName}`,
         targetParams,
       );
       const payload = extractPayload(targetResult);
-- 
2.50.1 (Apple Git-155)

